package incognito.mod.protection;

import incognito.mod.util.KeybindDefaults;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Tracks Component information from anvil items for exploit protection.
 * Used by AnvilScreenMixin and AnvilMenuMixin to communicate.
 */
public final class AnvilExploitTracker {
    
    public record ComponentInfo(
        String originalKey,
        String resolvedValue,
        String vanillaDefault,
        boolean isKeybind
    ) {}
    
    private static final Map<String, ComponentInfo> resolvedToOriginal = new ConcurrentHashMap<>();
    private static String originalResolvedName = null;
    private static boolean hasExploitContent = false;
    
    private AnvilExploitTracker() {}
    
    public static Map<String, ComponentInfo> getResolvedMapping() {
        return new HashMap<>(resolvedToOriginal);
    }
    
    public static String getOriginalResolvedName() {
        return originalResolvedName;
    }
    
    public static boolean hasExploitContent() {
        return hasExploitContent;
    }
    
    public static void clearMapping() {
        resolvedToOriginal.clear();
        originalResolvedName = null;
        hasExploitContent = false;
    }
    
    public static void setOriginalResolvedName(String name) {
        originalResolvedName = name;
    }
    
    public static void setHasExploitContent(boolean hasExploit) {
        hasExploitContent = hasExploit;
    }
    
    public static void addMapping(String resolved, ComponentInfo info) {
        resolvedToOriginal.put(resolved, info);
    }
    
    public static String getVanillaDefaultOrElse(String key, String fallback) {
        return KeybindDefaults.getDefaultOrElse(key, fallback);
    }
    
    public static String getSpoofedText(String input) {
        if (input == null || input.isEmpty() || resolvedToOriginal.isEmpty()) {
            return input;
        }
        
        String result = input;
        for (Map.Entry<String, ComponentInfo> entry : resolvedToOriginal.entrySet()) {
            String resolved = entry.getKey();
            ComponentInfo info = entry.getValue();
            
            if (result.contains(resolved)) {
                String replacement = info.isKeybind() ? info.vanillaDefault() : info.originalKey();
                result = result.replace(resolved, replacement);
            }
        }
        
        return result;
    }
    
    public static String getSanitizedText(String input) {
        if (input == null || input.isEmpty() || resolvedToOriginal.isEmpty()) {
            return input;
        }
        
        String result = input;
        for (String resolved : resolvedToOriginal.keySet()) {
            if (result.contains(resolved)) {
                result = result.replace(resolved, "");
            }
        }
        
        return result;
    }
}

